
# The Linux project

Hi!
Here's the Linux Project result for eductive07.
# Purpose
* Use Terraform to build infrastructure (1 frontend, 6 backends splited in 2 datacenters, 1 DB service)
	* Use ansible to configure many services
		* Loadbalencer : HAPROXY
		* Website : NGINX
		* DOCKER, NFS, FIREWALL
	* Use ansible to deploy docker's container
	* Use docker to deploy :
			* Ifconfig.io on backends
			* Wordpress on backends (shared in NFS folder)
# Important infos
### Terraform was used with binary file (not installed)
Version : 
>Terraform v1.3.6
>on linux_amd64
> (outdated version)
### Ansible version (installed)
This project was not made to use ansible-galaxy or roles
>ansible [core 2.13.4]
>python version = 3.10.8 (main, Nov  4 2022, 09:21:25) [GCC 12.2.0]
>jinja version = 3.0.3
>libyaml = True

# Files

## Secret file required
You need to provide Cloud Provider (CP) variables linked to your cloud account. You can avoid this step but making your infrastructure less secured. Try to documente about TF vars (Terraform variables)
You need a SSH private key declared to your CP.

See how to make that secret file : [OVH Exemple](https://www.grottedubarbu.fr/ovh-api-openstack/) 

See how to use provider infos in API  : [OVH Exemple](https://registry.terraform.io/providers/ovh/ovh/latest/docs)

## Gitignored files
Files containing sensitive data as ansible inventory (hosts, IP, DB user, DB pwd, ...) are excluded but will be self-generated by using terraform/ansible.

## Usable files
### Terraform
* projet.tf : Contain the build setup
* variables.tf : contain variables used in projet.tf
* output.tf : Use to recover sensitive DB id safely
* inventory.tmpl : Template for Ansible inventory
* openrc.sh : contain secret vars used for API
* provider.tf : contain CP infos
### Ansible
* Inventory.yml : All servers build by Terraform. Created after terraform have run. Contains some variables
* main_playbook.yml : Update & Upgrade all hosts, then start other playbooks
* ansible.cfg : Config to auto-accept ssh yes/no/fingerprint. Can be deleted
* ./Playbooks
	* Haproxy playbook: install, config, start HAPROXY
	* Nginx playbook : install, config, start NGINX
	* NFS playbook : install, config, start NFS share
	* Docker playbook : install DOCKER and DOCKER COMPOSE
	* Ifconfig playbook : start ifconfig container by docker-compose in backends
	* Wordpress playbook : start wordpress container by docker-compose in backends (linked to db service)
* ./Templates
	* Contain every service configuration file
	* Contain docker-compose files

# How to use
## Check file's syntax
You can use those commands to verify yaml syntaxe :
> tflint file.tf (for terraform)
> yamllint file.yml (for yaml)
## Declare provider's ID
Declare your account IDs

```text
source openrc.sh
```

## Start Terraforming
If you don't have terraform installed you can use standalone terraform binary

 Go to Terraform folder
```text
cd git_clone_folder/terraform
```
Init Terraform
```text
terraform init
./terraform_binary init
```

See what will be done
```text
terraform plan
./terraform_binary plan
```
Deploy Terraform configuration (Ensure *.tf files mentionned are in that folder)
```text
terraform apply
./terraform_binary apply
>>> yes
```
> Wait until the end

See what have been build 
```text
terraform show
./terraform_binary show
```

## Switch to ansible

```text
cd ../ansible
```
## Ensure inventory have been build
```text
cat inventory.yml
```
> It should contain 1 front and 2*3 backends ip adresses, one DB FQDN with some variables

## Ping your inventory (db should be in error)
```text
ansible all -m ping -v -i inventory.yml
```
## Start ansible
### Might be a issue : 
If you have build many time this project, or used OVH's ASNs for SSH :
You may need to clean your ssh known hosts due to replicated ip 
> see public IPs :
> > terraform show

> clean this file :
> > rm  ~/.ssh/known_hosts
> >nano/vi   ~/.ssh/known_hosts

> For cleaning a single Ip  :
> >ssh-keygen -f ~/.ssh/known_hosts -R [already used IP]

Make sure to wait few minutes before starting. Apt upgrade might failed because of CP's actions at startup

Start to build :
```text
ansible-playbook -i inventory.yml main_playbook.yml
```
> You should see every playbook running and configurations details

# CONFIGURATIONS DETAILS
* All backends are unreachable from WAN. Iptables contain them in the terraform's subnet, except for SSH (for ansible)
* Backends can be reached by frontend and other backends
* Frontend (HAPROXY) have open ports: 
	* 22 : SSH for ansible
	* 80 : load balancing NGINX (backend public IP)
	* 81 : Load Balancing NGINX (backend private IP)
	* 82 : Wordpress 
	* 8500 : ifconfig.io
	* 8080 : HAProxy monitoring
* Front shared NFS is in /home and NFS is mount on backends at same spot. Wordpress use this volume to share the same config beetween every wordpress container.
* App ifconfig.io can be accessed directly on backend : ip:8080
# Enjoy 
Frontend:22,80,81,82,8500,8080
Backend:8080
# Further
Most of the instance creation and builds are made of dynamics variables and groups, wich mean you can easly increase the infrastructure capacity. 
To increase front's number you'll need to manage ansible playbook to change the "default_ipv4.address" loops.
Lots of variables such as app used in container, folder location, vlan ID, etc are variable-based, they can easly be changed.